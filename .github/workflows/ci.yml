
name: CI
on: [push]

jobs:
  build:
    name: Build Windows
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v1
    - uses: nuget/setup-nuget@v1
    - name: Cache third-party dependencies
      id: cache-thirdparty
      uses: actions/cache@v2
      with:
        path: thirdparty/external/packages
        key: ${{ hashFiles('thirdparty/external/**/*') }}
    - name: Build third-party dependencies
      if: steps.cache-thirdparty.outputs.cache-hit != 'true'
      run: |
        call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvars32.bat"
        cd thirdparty\external
        call regenerate.cmd
      shell: cmd
    - name: Install NuGet packages
      run: |
        nuget install Squirrel.Windows -OutputDirectory Squirrel -Verbosity Detailed
        nuget restore
    - name: Build
      run: |
        call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvars32.bat"
        cmake -GNinja -Bbuild -DCMAKE_BUILD_TYPE=Release -DTP_VERSION=%BUILD_NUMBER% -DTP_COMMIT=%COMMIT_ID% -DTP_RELEASE_BUILD=ON
        cmake --build build
      # Need to use cmd because of the vcvars32 batch file
      shell: cmd
      env:
        BUILD_NUMBER: ${GITHUB_RUN_NUMBER}
        COMMIT_ID: ${GITHUB_SHA::8}
